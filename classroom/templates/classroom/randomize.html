{% extends 'classroom/base.html' %}


{% block body %}
<div class="container">
    <div class="row">
        <div class="col-md-2">
            <div id="djangorandom">
            {{ classroom.id }}
                <form action="{% url 'classroom:random' %}" method="get">
                    {% csrf_token %}
                    <div class="form-group">
                        <select class="form-control" name="class_block">
                            {% for room in classroom %}
                                <option value={{ room.course_block }}>{{ room.get_course_block_display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <span><input class="btn btn-default" type="submit" value="Submit"></span>
                </form>

            </div>
        </div>
        <div class="col-md-10">
            <div class="btn-toolbar">
                <button class="btn btn-success" type="submit" id="go">&raquo; Run</button>
                <button class="btn btn-warning" type="submit" id="stop">&raquo; Random Name</button>
                <button class="btn btn-warning" type="submit" id="freeze">&raquo; Random Groups</button>
                <a class="btn btn-default" href="{% url 'classroom:classroom' %}" role="button">CLICK HERE TO ADD A CLASS</a>
                <a class="btn btn-default" href="{% url 'classroom:blocklist' %}" role="button">CLICK HERE TO EDIT A CLASS</a>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-2">
            <div id="student-column"></div>  <!-- anchor element for js -->
        </div>
        <div class="col-md-2">
            <div id="student-choice"></div>  <!-- anchor for student choice -->
        </div>

    </div>


</div>
{% endblock body %}
<div>

{% block extra_js %}
            <script>
                var nameArray = {{ data | safe }};
                console.log(typeof(nameArray))
                console.log(nameArray)
                
                var N = 3; // group size
                var previousGroups = 0;  // # groups of previous freeze
                
                var numberStudents = nameArray.length;
                var interval;
                var loopAllowed = false;
                var attend = [];
                var groupMade = false;
                
                for(var n = 0; n < numberStudents; n++) {
                    attend[n] = nameArray[n].fields.attend;
                    };
                var studentCol = document.getElementById('student-column');
                var studentChoice = document.getElementById('student-choice');
                var vertGap = 30;
                var divChoice = document.createElement('div');             
                
                var offsetsChoice = document.getElementById('student-choice').getBoundingClientRect();
                var topChoice = offsetsChoice.top;
                var leftChoice = offsetsChoice.left;
                
                var offsetsCol = document.getElementById('student-column').getBoundingClientRect();
                var topCol = offsetsCol.top;
                var leftCol = offsetsCol.left;
                console.log(topCol);
                
                divChoice.id = "choicename";

                divChoice.innerHTML = " ";
                studentChoice.appendChild(divChoice);

                var setNames = function() {
                    var h = 0;
                    for(var n = 0; n < numberStudents; n++){   <!-- place the names on the screen -->
                        var extraW = 0;
                        var w = 0;
                        var divName = "floatName" + n;
                        var names = nameArray[n].fields.nickname;
                        var divTag = document.createElement('div');
                        divTag.id = divName;
                        divTag.innerHTML = names;
                        divTag.style.position = "absolute";
                        if (attend[n] == true) {
                            divTag.style.textDecoration = "none";
                        } else {
                            divTag.style.textDecoration = "line-through";
                            divTag.style.color = 'red';
                        };
                        w = Math.floor(n/15)*120 - 120;  <!-- shift the columns to the right by 120 -->
                        h = n - Math.floor(n/15)*15;  <!-- go back up to the top of the name column -->
                        divTag.style.top = (10 + h * vertGap) + "px";
                        divTag.style.left  = (leftCol + w) + "px";
                        divTag.className = "randomFloat";
                        divTag.onclick = boldText;
                         
                        studentCol.appendChild(divTag); <!-- attach to studentCol/'anchor'/parent element -->
                        };
                    };
                setNames();
                    
                $( "#go" ).click(function() {
                    console.log("it's go time");
                    //clear the previous random name choice if there is one
                    var divfc = document.getElementById('choicename');
                    console.log(divfc);
                    while(divfc.firstChild) {
                        divfc.removeChild(divfc.firstChild);
                    };
                    
                    // get the number of kids attending before clearGroups
                    group = grouping(N);
                    if (groupMade == true) {
                        clearGroups(group[0]);
                    }

                    var gotime = 1;
                    interval = setInterval(function () {
                        for(var i = 0; i < (numberStudents + 1); i++){
                            var divName = "floatName" + i;
                            if (attend[i] == true) {
                                $( "#" + divName ).css({
                                    left: (Math.random()*500+300) + "px",
                                    top: (Math.random()*350 + 40) + "px"
                                });
                            };
                        };
                        gotime += 1;
                        if (gotime > 100) {
                            clearInterval(interval);
                           }
                    }, 500);
                });
   
                $( "#stop" ).click(function() {
                    clearInterval(interval);
                    choosePerson(0, numberStudents);
                    setTimeout(clearDivs, 1000);
                });
                
                var clearDivs = function() {
                    for(var i = 0; i < (numberStudents); i++) {
                        divn = "floatName" + i;
                        var elem = document.getElementById(divn);
                        elem.remove();
                        };
                    setNames();
                    };
                    
                var clearGroups = function() {
                    console.log(previousGroups);
                    for (i = 0; i < previousGroups; i++) {  //remove the previous # of groups
                        num = (i+1);
                        var divn = "Group" + num.toString();
                        var elem = document.getElementById(divn);
                        elem.remove();
                        };
                    clearDivs();
                    groupMade = false;
                    }; 
                    
                    
                function choosePerson (min, max) {
                    min = Math.ceil(min);
                    max = Math.floor(max);
                    var rn = Math.floor(Math.random() * (max - min)) + min;
                    if (attend[rn] == false) {
                        console.log(rn);
                        console.log("choose again");
                        return choosePerson(0, numberStudents);
                    };
                    divChoice.innerHTML = nameArray[rn].fields.nickname;
                    divChoice.style.position = "relative";
                    divChoice.style.color = "blue";
                    divChoice.style.fontWeight = "bold";
                    divChoice.style.top = "10px";
                    divChoice.style.left = "400px";
                    studentChoice.appendChild(divChoice);
                    console.log(shuffle(numberStudents));
                    };
                                      
                function boldText(){
                    var togname = this.id.split('floatName').join('');
                    console.log(togname);
                    var nam = nameArray[togname];
                    console.log(nam);
                    if (this.style.textDecoration == 'none') {
                        this.style.textDecoration = 'line-through';
                        this.style.color = 'red';
                        attend[togname] = false;
                    } else {
                        this.style.textDecoration = 'none';
                        this.style.color = 'black';
                        attend[togname] = true;
                    }
                    //console.log(attend[togname]);
                    };
                    
                // knuff-shuffle to mix the list of students
                function shuffle() {
                    var array = [];
                    for (var n=0; n<numberStudents; n++) {
                        array[n-0] = n;
                    }
                    var currentIndex = array.length
                      , temporaryValue
                      , randomIndex
                      ;

                    // While there remain elements to shuffle...
                    while (0 !== currentIndex) {

                      // Pick a remaining element...
                      randomIndex = Math.floor(Math.random() * currentIndex);
                      currentIndex -= 1;

                      // And swap it with the current element.
                      temporaryValue = array[currentIndex];
                      array[currentIndex] = array[randomIndex];
                      array[randomIndex] = temporaryValue;
                    }

                    return array;
                }
                
                function grouping(e) {
                    var ns = 0;
                    // make sure to not count students that are away
                    for (n=0; n < numberStudents; n++) {
                        if (attend[n] == true) {
                            ns++
                        };
                    };
                    
                    var extras = ns % e;
                    var numGroups = [];
                    var totalGroups = 0;
                    var threeGroups = Math.floor(ns/e);
                    
                    if (extras != 0) {
                        totalGroups = threeGroups + 1;
                    } else {
                        totalGroups = threeGroups;
                    }
                    return [totalGroups, ns]; 
                }
                
                function sort() {
                    var i = 0;
                    var sortName  = [];
                    var groupNumbers = [];
                    var placeCount = 0;
                    var groupDown = 0;
                    var groupLeft = 0;
                    groupMade = true;
                    var studentAttend = 0;
                    
                    // get the random order of students
                    var groups = grouping(N);
                    console.log(groups[0]);
                    console.log(groups[1]);
                    previousGroups = groups[0];
                    
                    // get the order of the students
                    var studentOrder = shuffle(nameArray);
                    console.log(studentOrder);
                    //var numberRows = groups[0]+groups[1];
                    for (i = 0; i < groups[0]; i++) {
                        num = (i+1);
                        divGroup = document.createElement('div');
                        divGroup.innerHTML = "Group " + num.toString();
                        divGroup.id = "Group" + num.toString();
                        num = num*110-120;
                        divGroup.style.width = "110px";
                        divGroup.style.fontWeight = "bold";
                        divGroup.style.color = "blue";
                        divGroup.style.position = "absolute";
                        divGroup.style.top = "100px";
                        divGroup.style.left = num.toString() + "px";
                        studentChoice.appendChild(divGroup);
                    }
                    for (i = 0; i < numberStudents; i++) {
                        var divName = "floatName" + studentOrder[i];
                        var SO = studentOrder[i];
                        if (attend[SO] == true) {
                            studentAttend++;
                            if (placeCount%groups[0] == 0) {
                                groupDown = groupDown + 50;
                                groupLeft = 0;
                            }
                            $( "#" + divName ).css({
                                left: (200 + groupLeft) + "px",
                                top: (100 + groupDown) + "px"
                            });
                            groupLeft = groupLeft + 110;
                            placeCount++;
                        }
                    } 
                };
               
                $( "#freeze" ).click(function() {
                    clearInterval(interval);
                    setTimeout(sort, 1000);
                   
                });
                
/*                var testDivs = function() {
                    for(var i = 0; i < (numberStudents); i++) {
                        divn = "floatName" + i;
                        var elem = document.getElementById(divn);
                        //elem.remove();
                        };
                    setNames();
                    }; */
            </script>
</div>
{% endblock extra_js %}


